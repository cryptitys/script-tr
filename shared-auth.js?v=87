// ã‚¯ãƒ­ã‚¹ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³SSOç”¨ã®å…±æœ‰èªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
class SharedAuthManager {
    constructor() {
        this.domain = '.cupiditys.lol';
        this.cookieName = 'sed_tokens';
        this.encryptionKey = this.generateKey();
    }

    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚·ãƒ•ãƒˆå€¤ã‚’ç”Ÿæˆï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹ï¼‰
    generateKey() {
        return window.location.hostname.split('.').slice(1,3).join('').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % 25 + 1;
    }

    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚·ãƒ¼ã‚¶ãƒ¼æš—å·ã«ã‚ˆã‚‹é›£èª­åŒ–
    obfuscate(str) {
        return str.split('').map(char => {
            const code = char.charCodeAt(0);
            // å°åˆ·å¯èƒ½æ–‡å­—ã®ç¯„å›²ã§ã‚·ãƒ•ãƒˆï¼ˆ32-126ï¼‰
            if (code >= 32 && code <= 126) {
                return String.fromCharCode(((code - 32 + this.encryptionKey) % 95) + 32);
            }
            return char;
        }).join('');
    }

    deobfuscate(str) {
        try {
            return str.split('').map(char => {
                const code = char.charCodeAt(0);
                // å°åˆ·å¯èƒ½æ–‡å­—ã®ç¯„å›²ã§ã‚·ãƒ•ãƒˆã‚’æˆ»ã™
                if (code >= 32 && code <= 126) {
                    return String.fromCharCode(((code - 32 - this.encryptionKey + 95) % 95) + 32);
                }
                return char;
            }).join('');
        } catch (e) {
            return null;
        }
    }

    // å¤ã„XORæš—å·ã®å¾©å·åŒ–ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
    oldDeobfuscate(str) {
        try {
            const oldKey = window.location.hostname.split('.').slice(1,3).join('').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return atob(str).split('').map(char => 
                String.fromCharCode(char.charCodeAt(0) ^ (oldKey % 256))
            ).join('');
        } catch (e) {
            return null;
        }
    }

    // ã‚¯ãƒ­ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒãƒ¼ãƒˆä»˜ãã§ã‚¯ãƒƒã‚­ãƒ¼ã‚’è¨­å®š
    setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + d.toUTCString();
        document.cookie = `${name}=${value};${expires};path=/;domain=${this.domain};SameSite=Strict;Secure`;
    }

    // ã‚¯ãƒƒã‚­ãƒ¼ã®å€¤ã‚’å–å¾—
    getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—
    getStoredAccounts() {
        const cookieData = this.getCookie(this.cookieName);
        if (!cookieData) return {};
        
        try {
            let rawData;
            
            // æ–°ã—ã„å½¢å¼ï¼ˆã‚·ãƒ¼ã‚¶ãƒ¼æš—å·ï¼‰ã‚’æœ€åˆã«è©¦ã™
            try {
                const deobfuscated = this.deobfuscate(cookieData);
                if (deobfuscated) {
                    rawData = JSON.parse(deobfuscated);
                } else {
                    throw new Error('Deobfuscation failed');
                }
            } catch (e) {
                // å¤ã„å½¢å¼ï¼ˆXORæš—å·ï¼‰ã¾ãŸã¯ç”Ÿã®JSONã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                try {
                    // å¤ã„XORæš—å·ã‚’è©¦ã™
                    const oldDeobfuscated = this.oldDeobfuscate(cookieData);
                    if (oldDeobfuscated) {
                        rawData = JSON.parse(oldDeobfuscated);
                    } else {
                        throw new Error('Old deobfuscation failed');
                    }
                } catch (e2) {
                    // ç”Ÿã®JSONã‚’è©¦ã™ï¼ˆç§»è¡ŒæœŸé–“ç”¨ï¼‰
                    rawData = JSON.parse(cookieData);
                }
            }
            
            // å¤ã„å½¢å¼ã‚’æ–°ã—ã„å½¢å¼ã«ç§»è¡Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            const normalizedData = this.normalizeAccountData(rawData);
            
            // äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼šå¤–éƒ¨ã‚³ãƒ¼ãƒ‰ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«å¤‰æ›
            return this.addCompatibilityLayer(normalizedData);
            
        } catch (e) {
            console.error('Failed to parse stored accounts:', e);
            return {};
        }
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
    saveAccount(ra, token, userName = null, additionalData = {}) {
        // æ—¢å­˜ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆäº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ä»˜ãï¼‰
        const accounts = this.getStoredAccounts();
        
        // æ–°ã—ã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’åŠ¹ç‡çš„ãªå½¢å¼ã§ä½œæˆ
        const accountData = {
            t: token,
            n: userName || ra,
            d: Date.now(),
            l: Date.now()
        };
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæä¾›ã•ã‚ŒãŸå ´åˆã¯æš—å·åŒ–ã—ã¦ä¿å­˜
        // Save encrypted password if provided
        if (additionalData.password) {
            accountData.p = this.obfuscate(additionalData.password);
        }
        
        // additionalDataã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã€çŸ­ã„ã‚­ãƒ¼åã§ä¿å­˜
        if (additionalData.roomCode) accountData.r = additionalData.roomCode;
        if (additionalData.allRooms) accountData.a = additionalData.allRooms;
        
        // äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–ã‚Šé™¤ã„ã¦ã€ç´”ç²‹ãªå†…éƒ¨å½¢å¼ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        const pureAccount = this.removePureAccountData(accounts[ra] || {});
        accounts[ra] = { ...pureAccount, ...accountData };
        
        // å†…éƒ¨å½¢å¼ã®ã¿ã§ã‚µã‚¤ã‚ºåˆ¶é™ã‚’é©ç”¨
        const pureAccounts = this.stripCompatibilityLayer(accounts);
        const limitedAccounts = this.limitAccountsBySize(pureAccounts);
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªé›£èª­åŒ–ã‚’é©ç”¨
        const jsonData = JSON.stringify(limitedAccounts);
        const obfuscatedData = this.obfuscate(jsonData);
        this.setCookie(this.cookieName, obfuscatedData, 30);
        
        return true;
    }

    // ã‚¯ãƒƒã‚­ãƒ¼ã‚µã‚¤ã‚ºåˆ¶é™ã«åŸºã¥ã„ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’åˆ¶é™
    limitAccountsBySize(accounts) {
        const maxSize = 3800; // 4KBåˆ¶é™ã‚ˆã‚Šå°‘ã—å°ã•ã
        
        // æœ€æ–°ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰é †ç•ªã«ä¸¦ã¹æ›¿ãˆ
        const sortedEntries = Object.entries(accounts)
            .sort((a, b) => (b[1].l || 0) - (a[1].l || 0));
        
        const limitedAccounts = {};
        let currentSize = 0;
        
        for (const [ra, data] of sortedEntries) {
            const entrySize = JSON.stringify({[ra]: data}).length;
            
            if (currentSize + entrySize <= maxSize) {
                limitedAccounts[ra] = data;
                currentSize += entrySize;
            } else {
                break; // ã‚µã‚¤ã‚ºåˆ¶é™ã«é”ã—ãŸ
            }
        }
        
        return limitedAccounts;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è¦åŒ–ï¼ˆå¤ã„å½¢å¼ã‹ã‚‰æ–°ã—ã„å½¢å¼ã«å¤‰æ›ï¼‰
    normalizeAccountData(rawData) {
        const normalizedData = {};
        
        for (const [ra, account] of Object.entries(rawData)) {
            // æ—¢ã«æ–°ã—ã„å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            if (account.l !== undefined) {
                normalizedData[ra] = account;
                continue;
            }
            
            // å¤ã„å½¢å¼ã‹ã‚‰æ–°ã—ã„å½¢å¼ã«å¤‰æ›
            const normalizedAccount = {
                t: account.t,
                n: account.n,
                d: account.d,
                l: account.last || account.l || Date.now()
            };
            
            if (account.roomCode) normalizedAccount.r = account.roomCode;
            if (account.allRooms) normalizedAccount.a = account.allRooms;
            if (account.p) normalizedAccount.p = account.p; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¿æŒ / Keep password
            
            normalizedData[ra] = normalizedAccount;
        }
        
        return normalizedData;
    }
    
    // äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼šå¤–éƒ¨ã‚³ãƒ¼ãƒ‰ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 
    addCompatibilityLayer(normalizedData) {
        const compatibleData = {};
        
        for (const [ra, account] of Object.entries(normalizedData)) {
            compatibleData[ra] = {
                // å†…éƒ¨å½¢å¼ï¼ˆçŸ­ã„ã‚­ãƒ¼åï¼‰
                ...account,
                // äº’æ›æ€§ã®ãŸã‚ã®é•·ã„ã‚­ãƒ¼å
                last: account.l,
                roomCode: account.r,
                userName: account.n,
                allRooms: account.a,
                password: account.p // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç”¨ / For password access
            };
        }
        
        return compatibleData;
    }
    
    // äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å–ã‚Šé™¤ã„ã¦å†…éƒ¨å½¢å¼ã®ã¿ã‚’æ®‹ã™
    stripCompatibilityLayer(compatibleData) {
        const pureData = {};
        
        for (const [ra, account] of Object.entries(compatibleData)) {
            pureData[ra] = {
                t: account.t,
                n: account.n,
                d: account.d,
                l: account.l || account.last
            };
            
            if (account.r || account.roomCode) pureData[ra].r = account.r || account.roomCode;
            if (account.a || account.allRooms) pureData[ra].a = account.a || account.allRooms;
            if (account.p || account.password) pureData[ra].p = account.p || account.password; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿æŒ / Keep password
        }
        
        return pureData;
    }
    
    // ç´”ç²‹ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆäº’æ›æ€§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’é™¤å»ï¼‰
    removePureAccountData(account) {
        const { last, roomCode, userName, allRooms, password, ...pureData } = account;
        return pureData;
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤
    removeAccount(ra) {
        const accounts = this.getStoredAccounts();
        delete accounts[ra];
        
        // å†…éƒ¨å½¢å¼ã§ä¿å­˜
        const pureAccounts = this.stripCompatibilityLayer(accounts);
        const jsonData = JSON.stringify(pureAccounts);
        const obfuscatedData = this.obfuscate(jsonData);
        this.setCookie(this.cookieName, obfuscatedData, 30);
        
        return true;
    }

    // æœ€çµ‚ä½¿ç”¨æ™‚åˆ»ã‚’æ›´æ–°
    updateLastUsed(ra) {
        const accounts = this.getStoredAccounts();
        if (accounts[ra]) {
            accounts[ra].l = Date.now();
            accounts[ra].last = Date.now(); // äº’æ›æ€§ã®ãŸã‚
            
            const pureAccounts = this.stripCompatibilityLayer(accounts);
            const jsonData = JSON.stringify(pureAccounts);
            const obfuscatedData = this.obfuscate(jsonData);
            this.setCookie(this.cookieName, obfuscatedData, 30);
        }
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ï¼ˆåŸºæœ¬ãƒã‚§ãƒƒã‚¯ - ã‚µãƒ¼ãƒãƒ¼æ¤œè¨¼ã§å¼·åŒ–ã™ã¹ãï¼‰
    isTokenValid(token) {
        try {
            // åŸºæœ¬JWTæ§‹é€ ã®æ¤œè¨¼
            const parts = token.split('.');
            if (parts.length !== 3) return false;
            
            // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
            const payload = JSON.parse(atob(parts[1]));
            
            // å­˜åœ¨ã™ã‚‹å ´åˆã¯æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
            if (payload.exp) {
                return Date.now() < payload.exp * 1000;
            }
            
            return true;
        } catch (e) {
            return false;
        }
    }

    // è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—
    getAccountsList() {
        const accounts = this.getStoredAccounts();
        return Object.entries(accounts).map(([ra, data]) => ({
            ra,
            name: data.n || ra,
            lastUsed: data.l || data.d, // 'last' -> 'l'
            isValid: true
        })).sort((a, b) => b.lastUsed - a.lastUsed);
    }

    // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
    clearAllAccounts() {
        this.setCookie(this.cookieName, '', -1);
    }
    
    // ä¿å­˜ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
    // Get saved password for account
    getSavedPassword(ra) {
        const accounts = this.getStoredAccounts();
        const account = accounts[ra];
        if (account && account.p) {
            return this.deobfuscate(account.p);
        }
        return null;
    }

    // ç¾åœ¨ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    getCurrentCookieSize() {
        const cookieData = this.getCookie(this.cookieName);
        return cookieData ? cookieData.length : 0;
    }
    
    // ã‚¯ãƒƒã‚­ãƒ¼ä½¿ç”¨çŠ¶æ³ã‚’å–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    getCookieStats() {
        const size = this.getCurrentCookieSize();
        const accounts = this.getStoredAccounts();
        const accountCount = Object.keys(accounts).length;
        
        // ç”Ÿã®JSONã‚µã‚¤ã‚ºã‚‚è¨ˆç®—ï¼ˆé›£èª­åŒ–å‰ï¼‰
        const pureAccounts = this.stripCompatibilityLayer(accounts);
        const rawJsonSize = JSON.stringify(pureAccounts).length;
        const obfuscationOverhead = size - rawJsonSize;
        
        return {
            currentSize: size,
            rawJsonSize: rawJsonSize,
            obfuscationOverhead: obfuscationOverhead,
            maxSize: 4096,
            usage: `${Math.round((size / 4096) * 100)}%`,
            accountCount: accountCount,
            averagePerAccount: accountCount > 0 ? Math.round(size / accountCount) : 0
        };
    }
}

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚»ãƒ¬ã‚¯ã‚¿UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
class AccountSelectorUI {
    constructor(authManager) {
        this.authManager = authManager;
        this.modal = null;
        this.isOpen = false;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLã‚’ä½œæˆ
    createModal() {
        const modal = document.createElement('div');
        modal.id = 'accountSelectorModal';
        modal.className = 'account-selector-modal hidden';
        modal.innerHTML = `
            <div class="account-selector-content">
                <div class="account-selector-header">
                    <h2>Selecionar Conta</h2>
                    <button class="close-btn" id="closeAccountSelector">Ã—</button>
                </div>
                <div class="account-selector-body">
                    <div class="saved-accounts-list" id="savedAccountsList">
                        <div style="text-align: center; padding: 20px;">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    <div class="account-selector-footer">
                        <button class="btn btn-danger" id="clearAllAccounts">Limpar Todas</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        this.modal = modal;
        this.attachEventListeners();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒ
    attachEventListeners() {
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('closeAccountSelector').addEventListener('click', () => {
            this.close();
        });

        // ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
        document.getElementById('clearAllAccounts').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja limpar todas as contas salvas?')) {
                this.authManager.clearAllAccounts();
                this.close();
                this.showNotification('Todas as contas foram removidas');
            }
        });

        // å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‰ã˜ã‚‹
        this.modal.addEventListener('click', (e) => {
            if (e.target === this.modal) {
                this.close();
            }
        });
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    populateAccounts() {
        const accountsList = document.getElementById('savedAccountsList');
        const accounts = this.authManager.getAccountsList();
        
        if (accounts.length === 0) {
            accountsList.innerHTML = `
                <div class="no-accounts-message">
                    <p>Nenhuma conta salva encontrada</p>
                    <p class="text-muted">FaÃ§a login para salvar sua conta</p>
                </div>
            `;
            return;
        }

        accountsList.innerHTML = accounts.map(account => {
            // RAã‚’ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã€åå‰ãŒé•ã†å ´åˆã¯ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦è¡¨ç¤º
            const nameDisplay = (account.name && account.name !== account.ra) 
                ? `<div class="account-subtitle">${account.name}</div>` 
                : '';
            
            return `
                <div class="account-item ${!account.isValid ? 'invalid' : ''}" data-ra="${account.ra}">
                    <div class="account-info">
                        <div class="account-name">${account.ra}</div>
                        ${nameDisplay}
                        <div class="account-last-used">
                            ${this.formatRelativeTime(account.lastUsed)}
                        </div>
                    </div>
                    <div class="account-actions">
                        <button class="btn-use-account" data-ra="${account.ra}">
                            ${account.isValid ? 'Usar' : 'Token Expirado'}
                        </button>
                        <button class="btn-remove-account" data-ra="${account.ra}">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
        }).join('');

        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
        accountsList.querySelectorAll('.btn-use-account').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const ra = e.target.dataset.ra;
                this.selectAccount(ra);
            });
        });

        accountsList.querySelectorAll('.btn-remove-account').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const ra = e.target.dataset.ra;
                if (confirm(`Remover conta ${ra}?`)) {
                    this.authManager.removeAccount(ra);
                    this.populateAccounts();
                    this.showNotification('Conta removida');
                }
            });
        });
    }

    // ç›¸å¯¾æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ - ã‚ˆã‚Šç°¡æ½”ã«
    formatRelativeTime(timestamp) {
        const diff = Date.now() - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) return `${days}d atrÃ¡s`;
        if (hours > 0) return `${hours}h atrÃ¡s`;
        if (minutes > 0) return `${minutes}m atrÃ¡s`;
        return 'Agora';
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ
    selectAccount(ra) {
        const accounts = this.authManager.getStoredAccounts();
        const account = accounts[ra];
        
        if (!account) {
            this.showNotification('Conta nÃ£o encontrada');
            return;
        }

        // \u6700\u7d42\u4f7f\u7528\u3092\u66f4\u65b0
        this.authManager.updateLastUsed(ra);
        
        // å¸¸ã«ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åŸ‹ã‚ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã•ã›ã‚‹
        if (window.performQuickLogin) {
            window.performQuickLogin(ra, account.t);
        } else {
            // é–¢æ•°ãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            document.getElementById('studentId').value = ra;
            document.getElementById('password').value = '**********';
            this.showNotification('Conta selecionada. Escolha uma aÃ§Ã£o para continuar.');
        }
        
        this.close();
    }

    // é€šçŸ¥ã‚’è¡¨ç¤º
    showNotification(message) {
        if (window.createNotification) {
            window.createNotification(message);
        } else {
            console.log(message);
        }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    open() {
        if (!this.modal) {
            this.createModal();
        }
        
        this.modal.classList.remove('hidden');
        this.isOpen = true;

        // ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«å°‘ã—é…å»¶ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç”Ÿæˆ
        requestAnimationFrame(() => {
            this.populateAccounts();
        });
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    close() {
        if (this.modal) {
            this.modal.classList.add('hidden');
        }
        this.isOpen = false;
    }
}

// ç°¡å˜ãªçµ±åˆã®ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹
class SharedAuthHelper {
    constructor(authManager, selectorUI) {
        this.authManager = authManager;
        this.selectorUI = selectorUI;
        this.STARRED_PASSWORD = '**********';
        this.savedToken = null;
        this.usingSavedAuth = false;
    }

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
    initQuickLoginButton(buttonId = 'quickLoginBtn', badgeId = 'accountCount') {
        const button = document.getElementById(buttonId);
        const badge = document.getElementById(badgeId);
        
        if (button) {
            button.addEventListener('click', () => {
                this.selectorUI.open();
            });
        }
        
        this.updateQuickLoginButton(buttonId, badgeId);
        return this;
    }

    // ã‚¯ã‚¤ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
    updateQuickLoginButton(buttonId = 'quickLoginBtn', badgeId = 'accountCount') {
        const button = document.getElementById(buttonId);
        const badge = document.getElementById(badgeId);
        
        if (button && badge) {
            const accounts = this.authManager.getAccountsList();
            if (accounts.length > 0) {
                button.style.display = 'flex';
                badge.textContent = accounts.length;
            } else {
                button.style.display = 'none';
            }
        }
    }

    // ä¿å­˜ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’åŸ‹ã‚ã‚‹
    fillLoginForm(userId, token, userIdFieldId = 'studentId', passwordFieldId = 'password') {
        const userField = document.getElementById(userIdFieldId);
        const passwordField = document.getElementById(passwordFieldId);
        
        if (userField && passwordField) {
            userField.value = userId;
            passwordField.value = this.STARRED_PASSWORD;
            
            // å¾Œã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
            this.savedToken = token;
            this.usingSavedAuth = true;
            
            // æœ€çµ‚ä½¿ç”¨ã‚’æ›´æ–°
            this.authManager.updateLastUsed(userId);
            
            // å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
            userField.dispatchEvent(new Event('input'));
            passwordField.dispatchEvent(new Event('input'));
            
            return true;
        }
        return false;
    }

    // ä¿å­˜ã•ã‚ŒãŸèªè¨¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    isUsingSavedAuth(passwordValue) {
        return passwordValue === this.STARRED_PASSWORD;
    }

    // ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    getSavedToken(userId = null) {
        // ã¾ãšãƒ¡ãƒ¢ãƒªã‚’ãƒã‚§ãƒƒã‚¯
        if (this.savedToken) {
            return this.savedToken;
        }
        
        // userIdãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¿å­˜ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
        if (userId) {
            const accounts = this.authManager.getStoredAccounts();
            const account = accounts[userId];
            if (account && account.t) {
                this.savedToken = account.t;
                this.usingSavedAuth = true;
                return account.t;
            }
        }
        
        return null;
    }

    // ä¿å­˜ã•ã‚ŒãŸèªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
    clearAuthSession() {
        this.savedToken = null;
        this.usingSavedAuth = false;
    }

    // æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‡¦ç†
    handleExpiredToken(userId, userIdFieldId = 'studentId', passwordFieldId = 'password') {
        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã™ãã«å‰Šé™¤ã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§å†è©¦è¡Œã•ã›ã‚‹
        const passwordField = document.getElementById(passwordFieldId);
        if (passwordField) {
            passwordField.value = '';
            passwordField.focus();
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä¿æŒ
        this.clearAuthSession();
        
        return 'Token expired. Please enter your password.';
    }

    // æˆåŠŸã—ãŸãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿å­˜
    saveSuccessfulLogin(userId, token, userName = null, additionalData = {}) {
        this.authManager.saveAccount(userId, token, userName, additionalData);
        this.updateQuickLoginButton();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã¨ã®è‡ªå‹•çµ±åˆã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    autoIntegrate(config = {}) {
        const defaults = {
            userIdFieldId: 'studentId',
            passwordFieldId: 'password', 
            quickLoginBtnId: 'quickLoginBtn',
            accountCountId: 'accountCount',
            loginHandler: null,
            onAccountSelected: null
        };
        
        const settings = { ...defaults, ...config };
        
        // ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
        this.initQuickLoginButton(settings.quickLoginBtnId, settings.accountCountId);
        
        // performQuickLoginã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
        window.performQuickLogin = (userId, token) => {
            this.fillLoginForm(userId, token, settings.userIdFieldId, settings.passwordFieldId);
            
            if (settings.onAccountSelected) {
                settings.onAccountSelected(userId, token);
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (window.createNotification) {
                    window.createNotification('Account selected. Choose an action to continue.');
                } else {
                    console.log('Account selected:', userId);
                }
            }
        };
        
        return this;
    }
}

// å…±æœ‰èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
const sharedAuth = new SharedAuthManager();
const accountSelector = new AccountSelectorUI(sharedAuth);
const sharedAuthHelper = new SharedAuthHelper(sharedAuth, accountSelector);

// ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
window.SharedAuthManager = sharedAuth;
window.AccountSelectorUI = accountSelector;
window.SharedAuthHelper = sharedAuthHelper;
